---
title: "Keyword analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)

library(tidyverse)
library(tidytext)
library(dendextend)
library(cluster)
```

## Goal

Cluster keywords present in SRA_human_metaInfo_20200301.tsv

```{r import-data}

# read data and split into tokens by ";" delimiter

set.seed(20200417)

SRA_meta <-
  read_delim("raw_data/SRA_human_metaInfo_20200301_labeled.tsv",
             delim = "\t", escape_double = FALSE, trim_ws = TRUE) %>%
  distinct(STUDY_ID, .keep_all = TRUE)

feces_ID <-
  SRA_meta %>%
  filter(CLASS == "feces") %>%
  sample_n(20) %>%
  pull(SAMPLE_ID)

saliva_ID <-
  SRA_meta %>%
  filter(CLASS == "saliva") %>%
  sample_n(20) %>%
  pull(SAMPLE_ID)

skin_ID <-
  SRA_meta %>%
  filter(CLASS == "skin") %>%
  pull(SAMPLE_ID)


SRA_meta <-
  SRA_meta %>%
  filter(SAMPLE_ID %in% c(feces_ID, saliva_ID, skin_ID))



SRA_meta_tokens <-
  SRA_meta %>%
  unnest_tokens(keyword, KEYWORDS, token = "regex", pattern=";") %>%
  filter(keyword != "human",
         keyword != "association",
         keyword != "human-associated")
```

```{r distance-function}

keyword_distance <-
  function(ID_1, ID_2){
    token_df <- SRA_meta_tokens
    
    words_1 <-
      token_df %>%
      filter(SAMPLE_ID == ID_1) %>%
      pull(keyword)
    
    words_2 <-
      token_df %>%
      filter(SAMPLE_ID == ID_2) %>%
      pull(keyword)
    
    shared <- length(intersect(words_1, words_2))
    unique <- length(unique(c(words_1, words_2)))
    
    return(1-(shared/unique))
    
  }

```

```{r distance-matrix}

SRA_meta_dist <-
  SRA_meta %>%
  expand(ID_first = SAMPLE_ID, ID_second = SAMPLE_ID) %>%
  filter(ID_first <= ID_second) %>%
  mutate(dist = map2_dbl(ID_first, ID_second, keyword_distance)) %>%
  pivot_wider(names_from = ID_first, values_from = dist) %>%
  select(-ID_second) %>%
  as.dist(diag = TRUE)

```



```{r heatmap}

heatmap(as.matrix(SRA_meta_dist))

```


```{r hierarchical-clustering}

SRA_meta_clust <- hclust(SRA_meta_dist)

SRA_meta_clust %>%
  as.dendrogram %>%
  set("branches_k_color", k = 3) %>% 
  plot()

SRA_meta_clust_3 <-
  bind_rows(cutree(SRA_meta_clust, k = 3)) %>%
  pivot_longer(everything(), names_to = "SAMPLE_ID", values_to = "cluster") %>%
  left_join(SRA_meta_tokens, by = "SAMPLE_ID")

SRA_meta_clust_3 %>%
  ggplot(aes(x = CLASS, y = cluster))+
  geom_jitter() +
  labs(x = NULL)

```



```{r summarize-clusters}

keyword_summary <- 
  SRA_meta_clust_3 %>%
  group_by(cluster) %>%
  count(keyword, sort = TRUE) %>%
  arrange(cluster)

```



